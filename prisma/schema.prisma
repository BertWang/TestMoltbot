// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. 資料夾/專案 (用於分類筆記) - 支援階層式結構
model Collection {
  id          String   @id @default(cuid())
  name        String
  description String?
  userId      String   // 多用戶擴充預留 (目前可設為 default "user")
  
  // 階層式結構 (自關聯)
  parentId    String?
  parent      Collection?  @relation("CollectionHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Collection[] @relation("CollectionHierarchy")
  
  // 元數據
  color       String?      // 資料夾顏色標記 (hex)
  icon        String?      // 資料夾圖示 (emoji 或 icon name)
  order       Int @default(0) // 排序順序
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  notes       Note[]   // 關聯：一個資料夾有多個筆記
  
  @@index([parentId])
  @@index([userId])
}

// 2. 筆記本體
model Note {
  id             String   @id @default(cuid())

  // 檔案資訊
  imageUrl       String   // 圖片存放路徑 (如果是本地開發，可能是 public/uploads/...)
  fileKey        String?  // 用於雲端儲存的 Key (選配)

  // A. 第一階段：原始辨識 (OCR)
  rawOcrText     String?  // 原始 OCR 結果 (尚未清理，可能含錯字)
  ocrProvider    String?  // 例如: "gemini-flash", "tesseract", "azure"
  
  // B. 第二階段：語意清理與核對 (AI Cleaning)
  refinedContent String?  // 經 AI 修正錯別字、手寫誤判後的最終 Markdown
  confidence     Float?   // AI 對辨識結果的信心分數 (0.0 - 1.0)
  
  // C. 第三階段：歸檔 (Classification)
  summary        String?  // AI 自動生成的摘要
  tags           String?   // 標籤 (SQLite 不支援 String[]，使用逗號分隔字串儲存，如 "tag1,tag2")

  // MCP 相關欄位
  mcpServicesUsed String? // 使用過的 MCP 服務列表 (JSON 格式)
  mcpMetadata     String? // MCP 操作結果元數據 (JSON 格式)

  // 狀態管理
  status         String   @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorMessage   String?  // 若失敗，記錄原因

  // 關聯
  collectionId   String?
  collection     Collection? @relation(fields: [collectionId], references: [id])
  
  // MCP 同步日誌關聯
  mcpSyncLogs    MCPSyncLog[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// 3. OCR 提供商配置 (方案 B: 多提供商支持)
model OCRProviderSetting {
  id               String   @id @default(cuid())
  provider         String   // gemini, azure, openai, googleVision, tesseract, textract
  enabled          Boolean  @default(false)
  priority         Int      @default(10)  // 優先級 1-100 (越小越優先)
  isDefault        Boolean  @default(false) // 是否為默認提供商
  
  // API 配置
  apiKey           String?  // 加密存儲的 API 密鑰
  apiKeyEncrypted  Boolean  @default(false) // 是否已加密
  endpoint         String?  // 自定義端點 (如 Azure)
  
  // 提供商特定配置 (JSON 格式)
  config           String?  // { "modelName": "...", "region": "...", ... }
  
  // 性能指標
  avgResponseTimeMs Int?    // 平均響應時間
  successRate      Float?   // 成功率 (0-1)
  costPerRequest   Float?   // 單次請求成本 (USD)
  
  // 狀態和限制
  status           String   @default("ACTIVE") // ACTIVE, INACTIVE, ERROR, RATE_LIMITED
  rateLimitPerMin  Int?     // 每分鐘請求限制
  monthlyQuota     Int?     // 月度配額
  monthlyUsage     Int?     // 當月使用量
  
  // 最後使用和錯誤
  lastUsedAt       DateTime?
  lastErrorAt      DateTime?
  lastErrorMessage String?
  
  // 元數據
  displayName      String?  // 顯示名稱
  description      String?  // 描述
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([provider])
  @@index([enabled])
  @@index([priority])
  @@index([status])
}

// 3a. 管理員設定與整合
model AdminSettings {
  id          String   @id @default("singleton")
  aiProvider  String   @default("gemini-2.0-flash") // e.g. gemini, openai, azure
  modelName   String   @default("gemini-2.0-flash")
  config      String?  // provider specific configuration serialized as JSON string
  
  // OCR 提供商設置 (方案 B)
  enabledOCRProviders String? @default("gemini") // 逗號分隔的啟用提供商列表
  defaultOCRProvider  String? @default("gemini") // 默認 OCR 提供商
  enableFailover      Boolean @default(true)     // 是否啟用故障轉移
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Integration {
  id         String   @id @default(cuid())
  provider   String   // e.g. "mcp", "notion"
  enabled    Boolean  @default(false)
  config     String?  // provider specific config serialized as JSON string
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// 4. 搜尋歷史 (Search History)
model SearchHistory {
  id        String   @id @default(cuid())
  query     String   // 搜尋查詢字符串
  filters   String?  // JSON 格式的篩選條件 (dateFrom, dateTo, status, etc.)
  resultCount Int    @default(0) // 返回結果數量
  userId    String?  // 用戶 ID (多用戶支援預留)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId, createdAt])
}

// 5. 保存的搜尋 (Saved Searches)
model SavedSearch {
  id          String   @id @default(cuid())
  name        String   // 保存搜尋的名稱 (例如: "重要筆記", "本月工作")
  query       String   // 搜尋查詢字符串
  filters     String?  // JSON 格式的篩選條件
  description String?  // 搜尋描述
  userId      String?  // 用戶 ID (多用戶支援預留)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([userId])
}

// 6. AI 聊天訊息 (Chat Messages)
model ChatMessage {
  id        String   @id @default(cuid())
  noteId    String   // 關聯的筆記 ID
  role      String   // "user" 或 "assistant"
  content   String   // 訊息內容
  tokens    Int?     // 使用的 token 數量 (用於計費)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([noteId, createdAt])
}

// ============ MCP 相關模型 ============

// 7. MCP 服務配置 (MCP Service Configuration)
model MCPServiceConfig {
  id                  String   @id @default(cuid())
  name                String   // 服務名稱 (例如: "OpenClaw 分析")
  type                String   // 服務類型 (openclaw, brave_search, github, slack 等)
  enabled             Boolean  @default(false)
  
  // 連接信息
  endpoint            String?  // API 端點 (可選)
  
  // 認證信息 (加密存儲)
  authType            String?  // api_key, oauth, jwt, basic
  credentials         String?  // 加密的認證憑證 (JSON 格式)
  
  // 服務特定配置
  config              String?  // 服務特定配置 (JSON 格式)
  
  // 性能和限制設置
  retryPolicy         String?  // 重試策略 (exponential, linear, none)
  rateLimitPerMinute  Int?     // 每分鐘速率限制
  timeoutMs           Int?     // 超時設置 (毫秒)
  
  // 優先級和狀態
  priority            Int      @default(0)
  isRequired          Boolean  @default(false) // 是否為必需服務
  
  // 元數據
  description         String?  // 服務描述
  lastTestedAt        DateTime? // 上次測試時間
  lastTestStatus      String?  // 上次測試結果 (success, failed)
  lastTestError       String?  // 上次測試錯誤訊息
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@unique([name])
  @@index([type])
  @@index([enabled])
}

// 8. MCP 同步日誌 (MCP Sync Log)
model MCPSyncLog {
  id                  String   @id @default(cuid())
  
  // 關聯信息
  noteId              String
  note                Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  serviceName         String   // 服務名稱
  action              String   // 操作類型 (process, extract, sync, notify 等)
  status              String   // 狀態 (pending, processing, success, failed)
  
  // 輸入和輸出
  input               String?  // 輸入數據 (JSON 格式)
  output              String?  // 輸出數據 (JSON 格式)
  error               String?  // 錯誤信息
  
  // 性能指標
  executionTimeMs     Int?     // 執行時間 (毫秒)
  
  // 重試信息
  retryCount          Int      @default(0)
  lastRetryAt         DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([noteId])
  @@index([serviceName])
  @@index([status])
  @@index([createdAt])
  @@index([noteId, serviceName])
}

// 9. MCP 快取 (MCP Cache) - 可選，用於存儲頻繁查詢的結果
model MCPCache {
  id                  String   @id @default(cuid())
  
  serviceName         String   // 服務名稱
  cacheKey            String   // 快取鍵值 (由查詢參數生成)
  cachedData          String   // 快取數據 (JSON 格式)
  
  expiresAt           DateTime // 快取過期時間
  
  createdAt           DateTime @default(now())
  
  @@unique([serviceName, cacheKey])
  @@index([expiresAt])
  @@index([serviceName])
}

// 10. MCP 服務註冊表 (MCP Service Registry)
// 市場上所有可用的 MCP 服務定義
model MCPServiceRegistry {
  id              String   @id @default(cuid())
  name            String   @unique           // 唯一標識符 (openclaw, brave_search 等)
  displayName     String                     // 顯示名稱
  description     String                     // 詳細描述
  category        String                     // 服務類別 (search, analysis, integration, automation)
  type            String                     // 服務類型 (openclaw, brave, github, slack, notion 等)
  version         String   @default("1.0.0") // 版本號
  logo            String?                    // Logo URL
  
  // 安裝統計
  totalInstalls   Int      @default(0)       // 總安裝數
  rating          Float?                     // 評分 (0-5)
  reviews         Int      @default(0)       // 評論數
  
  // 配置要求 (JSON 格式)
  requiredFields  String?                    // 必需字段列表
  optionalFields  String?                    // 可選字段列表
  
  // 文檔和資源
  documentation  String?                     // 文檔 URL
  homepage       String?                     // 主頁 URL
  repositoryUrl  String?                     // Git 倉庫 URL
  
  // 元數據
  isActive       Boolean  @default(true)     // 是否活躍
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@index([category])
  @@index([type])
  @@index([name])
  @@index([isActive])
}
